name: Build Beta Release

on:
  push:
    tags:
      - 'v*-beta*'    # åŒ¹é… v1.5.0-beta.1 æ ¼å¼
      - 'v*-rc*'      # åŒ¹é… v1.5.0-rc.1 æ ¼å¼
      - 'v*-alpha*'   # åŒ¹é… v1.5.0-alpha.1 æ ¼å¼
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Beta ç‰ˆæœ¬å· (å¦‚ v1.5.0-beta.1)'
        required: false
        default: 'dev'

# æ·»åŠ æƒé™å£°æ˜ï¼Œå…è®¸åˆ›å»º Release
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - variant: standard
            requirements: requirements.txt
            suffix: ""
            display_name: "æ ‡å‡†ç‰ˆ"
          - variant: shield
            requirements: requirements-shield.txt
            suffix: "_Shield"
            display_name: "Shield å¢å¼ºç‰ˆ"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies (${{ matrix.display_name }})
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ matrix.requirements }}
      
      - name: Download FFmpeg (GPL å®Œæ•´ç‰ˆ)
        run: |
          # ä¸‹è½½ FFmpeg GPL å®Œæ•´ç‰ˆ (åŒ…å« libx264/libx265 ç¼–ç å™¨)
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          # å¤åˆ¶åˆ° bin ç›®å½•
          New-Item -ItemType Directory -Force -Path "bin"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" -Destination "bin\"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffprobe.exe" -Destination "bin\"
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          Remove-Item -Recurse -Force "ffmpeg_temp"
          Remove-Item "ffmpeg.zip"
      
      - name: Get version
        id: version
        run: |
          # ä¼˜å…ˆä½¿ç”¨ tagï¼Œå¦åˆ™ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥ï¼Œæœ€åå›é€€åˆ° dev
          $version = "${{ github.ref_name }}"
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          }
          if (-not $version -or $version -eq "" -or $version -eq "refs/heads/dev") { 
            $version = "dev-$(Get-Date -Format 'yyyyMMdd-HHmm')" 
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
      
      - name: Inject version to source
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          # å»æ‰ v å‰ç¼€ (v1.5.0-beta.1 -> 1.5.0-beta.1)
          $version_clean = $version -replace '^v', ''
          Write-Host "Injecting version: $version_clean"
          
          # æ›¿æ¢ gui_config.py ä¸­çš„ç‰ˆæœ¬å· (æ–°ç»“æ„)
          if (Test-Path "src\gui_config.py") {
            $content = Get-Content "src\gui_config.py" -Raw -Encoding UTF8
            $content = $content -replace '"version":\s*"[^"]*"', "`"version`": `"$version_clean`""
            Set-Content "src\gui_config.py" -Value $content -Encoding UTF8 -NoNewline
            Write-Host "Updated src\gui_config.py"
          }
          
          # å…¼å®¹æ—§ç»“æ„ï¼šæ›¿æ¢ main.py ä¸­çš„ç‰ˆæœ¬å·
          $content = Get-Content "main.py" -Raw -Encoding UTF8
          if ($content -match '"version":') {
            $content = $content -replace '"version":\s*"[^"]*"', "`"version`": `"$version_clean`""
            Set-Content "main.py" -Value $content -Encoding UTF8 -NoNewline
            Write-Host "Updated main.py"
          }
      
      - name: Build with PyInstaller (${{ matrix.display_name }})
        run: |
          pyinstaller XiaoXueToolbox.spec --noconfirm
      
      - name: Create release package (${{ matrix.display_name }})
        run: |
          Compress-Archive -Path "dist\XiaoXueToolbox\*" -DestinationPath "XiaoXueToolbox_${{ steps.version.outputs.VERSION }}${{ matrix.suffix }}_Windows_x64.zip"
      
      - name: Upload artifact (${{ matrix.display_name }})
        uses: actions/upload-artifact@v4
        with:
          name: XiaoXue-Video-Tools-${{ steps.version.outputs.VERSION }}${{ matrix.suffix }}
          path: XiaoXueToolbox_${{ steps.version.outputs.VERSION }}${{ matrix.suffix }}_Windows_x64.zip
          retention-days: 14
      
      - name: Create Pre-release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: XiaoXueToolbox_${{ steps.version.outputs.VERSION }}${{ matrix.suffix }}_Windows_x64.zip
          generate_release_notes: true
          draft: false
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          name: "ğŸ§ª å°é›ªå·¥å…·ç®± ${{ steps.version.outputs.VERSION }} (æµ‹è¯•ç‰ˆ)"
          body: |
            ## ğŸ§ª å°é›ªå·¥å…·ç®± ${{ steps.version.outputs.VERSION }} (æµ‹è¯•ç‰ˆ)
            
            > âš ï¸ **è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬ (Pre-release)**ï¼Œå¯èƒ½åŒ…å«æœªå®Œæˆçš„åŠŸèƒ½æˆ–å·²çŸ¥é—®é¢˜ã€‚
            > ä»…ä¾›æµ‹è¯•ä½¿ç”¨ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚
            
            ### ç‰ˆæœ¬é€‰æ‹©
            
            | ç‰ˆæœ¬ | è¯´æ˜ |
            |------|------|
            | `XiaoXueToolbox_${{ steps.version.outputs.VERSION }}_Windows_x64.zip` | æ ‡å‡†ç‰ˆ |
            | `XiaoXueToolbox_${{ steps.version.outputs.VERSION }}_Shield_Windows_x64.zip` | Shield å¢å¼ºç‰ˆ |
            
            ### æµ‹è¯•è¯´æ˜
            - è¿™æ˜¯åŸºäº `dev` åˆ†æ”¯æ„å»ºçš„æµ‹è¯•ç‰ˆæœ¬
            - è¯·åœ¨æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨
            - å‘ç°é—®é¢˜è¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) åé¦ˆ
            
            ### å˜æ›´å†…å®¹
            è¯¦è§è‡ªåŠ¨ç”Ÿæˆçš„ Release Notes æˆ–æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/dev/CHANGELOG.md)

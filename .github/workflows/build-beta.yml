name: Build Beta Release

on:
  push:
    tags:
      - 'v*-beta*'    # 匹配 v1.5.0-beta.1 格式
      - 'v*-rc*'      # 匹配 v1.5.0-rc.1 格式
      - 'v*-alpha*'   # 匹配 v1.5.0-alpha.1 格式
  workflow_dispatch:  # 支持手动触发
    inputs:
      version:
        description: 'Beta 版本号 (如 v1.5.0-beta.1)'
        required: false
        default: 'dev'

# 添加权限声明，允许创建 Release
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - variant: standard
            requirements: requirements.txt
            suffix: ""
            display_name: "标准版"
          - variant: shield
            requirements: requirements-shield.txt
            suffix: "_Shield"
            display_name: "Shield 增强版"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies (${{ matrix.display_name }})
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ matrix.requirements }}
      
      - name: Download FFmpeg (GPL 完整版)
        run: |
          # 下载 FFmpeg GPL 完整版 (包含 libx264/libx265 编码器)
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          # 复制到 bin 目录
          New-Item -ItemType Directory -Force -Path "bin"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" -Destination "bin\"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffprobe.exe" -Destination "bin\"
          # 清理临时文件
          Remove-Item -Recurse -Force "ffmpeg_temp"
          Remove-Item "ffmpeg.zip"
      
      - name: Get version
        id: version
        run: |
          # 优先使用 tag，否则使用手动输入，最后回退到 dev
          $version = "${{ github.ref_name }}"
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          }
          if (-not $version -or $version -eq "" -or $version -eq "refs/heads/dev") { 
            $version = "dev-$(Get-Date -Format 'yyyyMMdd-HHmm')" 
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
      
      - name: Inject version to source
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          # 去掉 v 前缀 (v1.5.0-beta.1 -> 1.5.0-beta.1)
          $version_clean = $version -replace '^v', ''
          Write-Host "Injecting version: $version_clean"
          
          # 替换 gui_config.py 中的版本号 (新结构)
          if (Test-Path "src\gui_config.py") {
            $content = Get-Content "src\gui_config.py" -Raw -Encoding UTF8
            $content = $content -replace '"version":\s*"[^"]*"', "`"version`": `"$version_clean`""
            Set-Content "src\gui_config.py" -Value $content -Encoding UTF8 -NoNewline
            Write-Host "Updated src\gui_config.py"
          }
          
          # 兼容旧结构：替换 main.py 中的版本号
          $content = Get-Content "main.py" -Raw -Encoding UTF8
          if ($content -match '"version":') {
            $content = $content -replace '"version":\s*"[^"]*"', "`"version`": `"$version_clean`""
            Set-Content "main.py" -Value $content -Encoding UTF8 -NoNewline
            Write-Host "Updated main.py"
          }
      
      - name: Build with PyInstaller (${{ matrix.display_name }})
        run: |
          pyinstaller XiaoXueToolbox.spec --noconfirm
      
      - name: Create release package (${{ matrix.display_name }})
        run: |
          Compress-Archive -Path "dist\XiaoXueToolbox\*" -DestinationPath "XiaoXueToolbox_${{ steps.version.outputs.VERSION }}${{ matrix.suffix }}_Windows_x64.zip"
      
      - name: Upload artifact (${{ matrix.display_name }})
        uses: actions/upload-artifact@v4
        with:
          name: XiaoXue-Video-Tools-${{ steps.version.outputs.VERSION }}${{ matrix.suffix }}
          path: XiaoXueToolbox_${{ steps.version.outputs.VERSION }}${{ matrix.suffix }}_Windows_x64.zip
          retention-days: 14
      
      - name: Create Pre-release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: XiaoXueToolbox_${{ steps.version.outputs.VERSION }}${{ matrix.suffix }}_Windows_x64.zip
          generate_release_notes: true
          draft: false
          prerelease: true  # 标记为预发布版本
          name: "小雪工具箱 ${{ steps.version.outputs.VERSION }} (测试版)"
          body: |
            ## 小雪工具箱 ${{ steps.version.outputs.VERSION }} (测试版)
            
            > **这是一个测试版本 (Pre-release)**，可能包含未完成的功能或已知问题。
            > 仅供测试使用，不建议在生产环境中使用。
            
            ### 版本选择
            
            | 版本 | 说明 |
            |------|------|
            | `XiaoXueToolbox_${{ steps.version.outputs.VERSION }}_Windows_x64.zip` | 标准版 |
            | `XiaoXueToolbox_${{ steps.version.outputs.VERSION }}_Shield_Windows_x64.zip` | Shield 增强版 |
            
            ### 测试说明
            - 这是基于 `dev` 分支构建的测试版本
            - 请在测试环境中使用
            - 发现问题请在 [Issues](https://github.com/${{ github.repository }}/issues) 反馈
            
            ### 变更内容
            详见自动生成的 Release Notes 或查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/dev/CHANGELOG.md)
